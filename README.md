# Метафора-конвертер (из DOAJ XML)

Онлайн-редактор и конвертёр, который преобразует выгрузку журнала в формате DOAJ XML в XML-файл для ИС «Метафора» по схеме выпусков journal3.

Небольшое PHP‑приложение без базы данных, которое:

1) принимает выгрузку **DOAJ XML** (по статьям одного выпуска),
2) раскладывает метаданные выпуска и статей в сессию,
3) даёт интерфейс для вычитки/правок,
4) генерирует **XML в формате «Метафора»**:
   - по одной статье,
   - общий файл на весь выпуск,
   - ZIP‑архив со всеми статьями.

Также поддерживается загрузка **HTML‑вёрстки выпуска** (опционально) для удобного предпросмотра и ручного «подтягивания» фрагментов текста в поля формы.

**Разработчик:** к.и.н. Растям Туктарович Алиев.

---

## Возможности

- Загрузка:
  - обязательный файл **DOAJ XML**,
  - опциональный файл **HTML** выпуска (для предпросмотра в редакторе).
- Редактирование метаданных выпуска:
  - названия журнала RU/EN,
  - ISSN / eISSN,
  - том, номер, год,
  - издатель, место издания.
- Редактирование метаданных статьи:
  - тип статьи (код словаря «Метафора», с валидацией и дефолтом `RAR`),
  - DOI, EDN,
  - заголовки RU/EN,
  - аннотации RU/EN,
  - ключевые слова RU/EN,
  - страницы (fpage/lpage),
  - дата публикации,
  - авторы (Фамилия/Инициалы RU/EN, e‑mail, ORCID, аффилиации RU/EN),
  - списки литературы RU/EN,
  - финансирование RU/EN.
- Предпросмотр HTML‑выпуска в `iframe` на странице редактирования статьи:
  - можно выделить текст в предпросмотре и кнопкой **«Спарсить»** подставить его в нужное поле.
  - для `textarea` выделение добавляется новой строкой, а не перезаписывает содержимое.
- Drag‑and‑drop сортировка статей в выпуске.
- Экспорт:
  - `download_one.php` — XML по одной статье,
  - `download_all.php` — единый XML со всеми статьями,
  - `download_zip.php` — ZIP со всеми статьями по отдельным XML.

---

## Требования

- PHP **8.x** (используются современные функции строк и строгая типизация).
- Расширения PHP:
  - `libxml` / SimpleXML (парсинг DOAJ XML),
  - `dom` (генерация XML «Метафора»),
  - `zip` (`ZipArchive`, для `download_zip.php`).
- Включённые сессии (`session_start()` вызывается в `functions.php`).

---

## Установка и запуск

### Вариант A. Локально через встроенный сервер PHP

1. Скопируйте файлы проекта в папку, например `doaj2metafora/`.
2. Перейдите в папку проекта:
   ```bash
   cd doaj2metafora
3. Запустите сервер:
php -S 127.0.0.1:8000
4. Откройте в браузере:

http://127.0.0.1:8000/index.php

## Вариант B. На хостинге

1. Скопируйте файлы проекта в каталог сайта.
2. Убедитесь, что PHP версии 8.x и расширение zip доступны.
3. Откройте index.php в браузере.

## Как пользоваться
1. Откройте index.php.
2. Загрузите файл DOAJ XML (обязательно).
3. При наличии загрузите HTML выпуска (опционально). HTML сохраняется в сессии и показывается «как есть» в iframe (см. раздел «Безопасность»).
4. После загрузки вы попадёте на dashboard.php:
* при необходимости поправьте поля выпуска и сохраните,
* при необходимости перетащите строки в таблице статей и сохраните порядок,
* откройте статью кнопкой «Редактировать».
5. На странице edit.php:
* корректируйте поля статьи,
* при наличии HTML‑предпросмотра: выделяйте фрагменты в iframe и нажимайте «Спарсить» рядом с нужным полем.
6. Экспортируйте результат:
* общий файл выпуска: «Скачать общий XML» (download_all.php),
* архив статей: «Скачать все статьи (ZIP)» (download_zip.php),
* по одной статье: кнопка на странице статьи (download_one.php?id=...).
7. Для начала работы со следующим выпуском используйте «Сбросить сессию» (reset.php).

## Данные и поля
### Данные выпуска (issue)

Хранятся в $_SESSION['issue'] и редактируются на dashboard.php:
* journal_title_ru
* journal_title_en
* issn
* eissn
* volume
* issue
* year
* publisher
* place

### Данные статьи (article)

Хранятся в $_SESSION['articles'][N] и редактируются на edit.php:

* type — код типа статьи (валидируется при генерации XML; при пустом/неизвестном значении используется RAR).
* doi, edn
* title_ru, title_en
* abstract_ru, abstract_en
* keywords_ru[], keywords_en[]
* fpage, lpage
* pub_date
* authors[]:
* surname_ru, given_ru
* surname_en, given_en
* email, orcid
* aff_ru, aff_en
* refs_ru[], refs_en[]
* funding_ru[], funding_en[]

Примечание: из DOAJ подтягиваются заголовки/аннотации/ключевые слова и авторы (как есть, без автотранслитерации). Списки литературы и финансирование DOAJ‑выгрузка в этом инструменте не заполняет — эти блоки предполагаются к вводу вручную в интерфейсе.

Структура проекта
* index.php — стартовая страница, загрузка DOAJ XML и опционального HTML.
* dashboard.php — форма выпуска + список статей + drag‑and‑drop сортировка + экспорт выпуска.
* edit.php — редактор статьи + предпросмотр HTML выпуска + кнопки «Спарсить».
* save_issue.php — сохранение полей выпуска в сессию.
* save_article.php — сохранение полей статьи в сессию.
* reorder_articles.php — сохранение порядка статей.
* preview_html.php — отдача HTML выпуска в iframe.
* download_one.php — экспорт XML одной статьи.
* download_all.php — экспорт единого XML со всеми статьями.
* download_zip.php — экспорт ZIP со всеми статьями.
* reset.php — сброс сессии.
* functions.php — парсинг DOAJ XML, утилиты, генерация XML «Метафора».
* style.css — стили интерфейса.

## Безопасность и ограничения

* Приложение не использует БД и хранит данные только в сессии. После сброса сессии данные будут потеряны.
* Загруженный HTML выпуска в preview_html.php отдаётся без экранирования (как есть). Это удобно для предпросмотра, но потенциально опасно:
* загружайте только доверенный HTML,
* при необходимости добавьте санитайзинг (удаление <script>, инлайновых обработчиков и т.п.) или отдавайте HTML в изолированном режиме.
* Инструмент рассчитан на сценарий «один выпуск → правки → экспорт». Для пакетной/потоковой обработки потребуется доработка (например, хранение состояния вне сессии).
